---
title: Reach Measurement with Shared Storage
sidebar_position: 8
---

reach-measurement-with-shared-storage

import Tabs from '@theme/Tabs'; import TabItem from '@theme/TabItem';

# Reach Measurement with Shared Storage

<Tabs>
<TabItem value="overview" label="Overview" default>

## Overview

### Description

This demo is used to show that reach can be measured directly using the existing Shared Storage and Private Aggregation APIs â€“ we call this approach a
direct method.

### Privacy Sandbox APIs and related documentation

- [Private Aggregation](https://developers.google.com/privacy-sandbox/private-advertising/private-aggregation)
- [Shared Storage](https://developers.google.com/privacy-sandbox/private-advertising/shared-storage)

### Related parties

- Advertiser
- DSP

</TabItem>
<TabItem value="Design" label="Design">

## Design

### Goals

In this demo, we assume an advertiser would like to measure the reach of marketing campaigns. By using a combination of Shares Storage and Private
Aggregation APIs, will demonstrate an effective method for reach measurement available within Privacy Sandbox.

### Assumptions

This use case assumes the advertiser has contracted with a publisher or won a bid to display their product ads on the publisher site (e.g. News site).
This use case does not cover ad-targeting specifics, so we assume the user would be presented with a relevant ad for which a reach measurement will be
attributed.

### Key Exclusions

The use case explores private aggregation reports before they are processed, aggregated, or summarized. This use case does not intend to demonstrate
the Aggregation Service nor noised aggregation reports.

### System Design

- The user visits the [news site](https://privacy-sandbox-demos-news.dev/static-ad-with-reach) where an ad is rendered.
- Using the shares storage `sharedStorage.get(*some_key*)` method, the browser queries for previous views of the ad.
- If the browser has not previously displayed the ad, a private aggregatable report is generated and sent to the `.well-known` endpoint via the
  `privateAggregation.contributeToHistogram()` method.
- The browser shared storage value is set to a value indicating _viewed_ .

#### User Journey #1

```mermaid

sequenceDiagram
Title: Single-touch conversion Attribution - User Journey 1

participant Browser
participant Publisher
participant SSP
participant Advertiser
participant DSP

Browser-)SSP:User visits a publisher site
SSP-->>Browser: SSP runs auction and load winning bid renderURL into an iframe*

Note right of Browser:* we skip the auction flow<br/> to focus on measurement and shared storage

Browser->>DSP:Browser loads ad creative

Browser-->>Browser:Check for previous ad viw sharedStorage.get(some_key) method.

Browser-->>Browser:If sharedStorage.get(some_key) fails to return result, create attribution report.

Note right of Browser:* we skip the attribution report flow<br/> if sharedStorage.get(some_key) returns a result.

Browser-)DSP: Contribute to privateAggregation.contributeToHistogram()

Browser-->>Browser: View atributable reports via chrome://private-aggregation-internals/

Browser-)DSP: View atributable reports delivered to .well-known endpoint (https://privacy-sandbox-demos-dsp.dev/reporting/view-reports)



```

</TabItem>
<TabItem value="demo" label="Demo">

## Demo

### Prerequisites

- Latest stable version of Chrome (Open `chrome://version` to check your current version)
- Enable Privacy Sandbox APIs (Open `chrome://settings/adPrivacy` to enable _Site-suggested ads_ and*Ad measurement*)
- Clear your browsing history before you run one of the demo scenario below (Open `chrome://settings/clearBrowserData` to delete your browsing
  history)
- Open chrome://attribution-internals and click "Clear all attribution data"

### User Journey #1

1. [Navigate to news site](https://privacy-sandbox-demos-news.dev/) (a publisher)
2. Open Chrome DevToolsS
3. View Application > Shared storage - verify has-reported-content has a single entry ![Shared Storage](./img/reach-measurement-shared-storage1.png)
4. Reload the page
5. View Application > Shared storage - verify has-reported-content has a single entry

6) View local Private Aggregation API Internals (Chrome generated) reports by pasting the following into your Chrome address box:
   `chrome://private-aggregation-internals/` verify a report has been generated by Chrome.
   ![Private Aggregation API Internals ](./img/reach-measurement-chrome-reports.png)

7) Click select the report and click "Send Selected Report"

8) Verify the report has been sent to the well-known endpoint:
   [https://privacy-sandbox-demos-dsp.dev/reporting/view-reports](https://privacy-sandbox-demos-dsp.dev/reporting/view-reports)
   ![Private Aggregation API Internals ](./img/reach-measurement-well-known-reports.png)

9) Verify no additional reports are sent to the well-known endpoint by repeating stems 1-8.

10) Delete Chrome shared storage via Chrome DevTools > Application > Shared storage ![Shared Storage](./img/reach-measurement-shared-storage2.png)

11) Verify new reports are sent by repeating stems 1-8.

### Implementation details

#### Using Shared Storage to identify previously displayed ads.

:::info

_Key term_: a [worklet](https://developer.mozilla.org/docs/Web/API/Worklet) lets you run specific JavaScript functions and return information back to
the requester. There are different types of worklets, Shared Storage uses the
[SharedStorageWorklet](https://developer.mozilla.org/docs/Web/API/SharedStorageWorklet) . Within a SharedStorageWorklet, you can execute JavaScript
but you cannot interact or communicate with the outside page.

:::

The ad returned by the AD server will include reference to the `reach-measurement-worklet.js` worklet. This worklet provides code to read from Shared
Storage:

```javaScript
class ReachMeasurementOperation {
  async run(data) {
  . . .


 Read from Shared Storage
    const key = 'has-reported-content: ' + contentId;
    const hasReportedContent = (await sharedStorage.get(key)) === 'true';

    // Do not report if a report has been sent already
    if (hasReportedContent) {
      console.log('Content ID already seen:  ' + key);
      return;
    }

    . . .

```

The reach-measurement-worklet.js file also provides our method for delivering or Attributable Report:

```javaScript
class ReachMeasurementOperation {
  async run(data) {
  . . .

   // Send an aggregatable report via the Private Aggregation API
    console.log('contributeToHistogram:');
    privateAggregation.contributeToHistogram({bucket, value});

    . . .

```

Once the privateAggregation.contributeToHistogram is called we can set the Shared Storage value to indicate that the ad has been seen using the
`sharedStorage.set(key, true)` method.

```javaScript
class ReachMeasurementOperation {
  async run(data) {
  . . .

  // Set the report submission status flag
    console.log('Shared Storage key ' + key + ' stored');
    await sharedStorage.set(key, true);

  . . .

```

</TabItem>
</Tabs>
